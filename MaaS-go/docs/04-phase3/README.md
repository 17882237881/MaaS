# é˜¶æ®µ3ï¼šä¼ä¸šçº§ç‰¹æ€§

> ğŸ­ **é˜¶æ®µç›®æ ‡**ï¼šå°†MaaSå¹³å°æ‰“é€ æˆç”Ÿäº§çº§åº”ç”¨ï¼Œå…·å¤‡é«˜å¯ç”¨ã€å¯è§‚æµ‹ã€æ˜“è¿ç»´çš„ç‰¹æ€§

## é˜¶æ®µæ€»è§ˆ

### å­¦ä¹ æ—¶é—´
**4å‘¨**ï¼ˆçº¦20ä¸ªå·¥ä½œæ—¥ï¼‰

### æ ¸å¿ƒç›®æ ‡
1. æŒæ¡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†æ¶æ„
2. å­¦ä¼šKuberneteså®¹å™¨ç¼–æ’
3. å®ç°é™æµç†”æ–­ä¿æŠ¤æœºåˆ¶
4. å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§
5. æ­å»ºå®Œæ•´çš„ç›‘æ§å‘Šè­¦ä½“ç³»

### æœ€ç»ˆäº§å‡º
- âœ… Kafkaæ¶ˆæ¯é˜Ÿåˆ—å¤„ç†å¼‚æ­¥ä»»åŠ¡
- âœ… Kuberneteséƒ¨ç½²é…ç½®
- âœ… é™æµç†”æ–­ä¿æŠ¤ç”Ÿæ•ˆ
- âœ… åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯
- âœ… Prometheus + Grafanaç›‘æ§ä»ªè¡¨ç›˜
- âœ… åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

## æŠ€æœ¯æ ˆè¯¦è§£

### 1. æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafkaï¼‰

**ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ**
æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ç§å¼‚æ­¥é€šä¿¡æœºåˆ¶ï¼Œç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—æ¥æ”¶æ¶ˆæ¯ï¼Œå®ç°ç³»ç»Ÿè§£è€¦ã€‚

**ä¸ºä»€ä¹ˆè¦ç”¨Kafkaï¼Ÿ**
- **é«˜ååé‡**ï¼šæ¯ç§’ç™¾ä¸‡çº§æ¶ˆæ¯
- **æŒä¹…åŒ–**ï¼šæ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œå¯é‡æ”¾
- **é«˜å¯ç”¨**ï¼šæ”¯æŒå¤šå‰¯æœ¬ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»
- **æ°´å¹³æ‰©å±•**ï¼šé€šè¿‡å¢åŠ åˆ†åŒºæ‰©å±•æ€§èƒ½

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **Topic**ï¼šæ¶ˆæ¯ä¸»é¢˜ï¼Œé€»è¾‘ä¸Šçš„æ¶ˆæ¯åˆ†ç±»
- **Partition**ï¼šåˆ†åŒºï¼Œç‰©ç†ä¸Šçš„æ¶ˆæ¯å­˜å‚¨å•å…ƒ
- **Producer**ï¼šç”Ÿäº§è€…ï¼Œå‘é€æ¶ˆæ¯
- **Consumer**ï¼šæ¶ˆè´¹è€…ï¼Œæ¥æ”¶æ¶ˆæ¯
- **Consumer Group**ï¼šæ¶ˆè´¹è€…ç»„ï¼Œç»„å†…æ¶ˆè´¹è€…å…±åŒæ¶ˆè´¹ä¸€ä¸ªTopic
- **Offset**ï¼šæ¶ˆæ¯åœ¨åˆ†åŒºä¸­çš„ä½ç½®

**Kafkaæ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Producer   â”‚â”€â”€â”€â”€â–¶â”‚   Broker    â”‚â”€â”€â”€â”€â–¶â”‚  Consumer   â”‚
â”‚  (ç”Ÿäº§è€…)   â”‚     â”‚  (æ¶ˆæ¯ä»£ç†)  â”‚     â”‚  (æ¶ˆè´¹è€…)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                    â”‚  Partition  â”‚
                    â”‚  (åˆ†åŒº)     â”‚
                    â”‚  [0,1,2,3]  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Kubernetes

**ä»€ä¹ˆæ˜¯Kubernetesï¼Ÿ**
Kubernetesï¼ˆK8sï¼‰æ˜¯Googleå¼€æºçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†å®¹å™¨åŒ–åº”ç”¨ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

**1. Pod**ï¼š
- æœ€å°çš„éƒ¨ç½²å•å…ƒ
- åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨
- å…±äº«ç½‘ç»œå’Œå­˜å‚¨

**2. Deployment**ï¼š
- ç®¡ç†Podçš„éƒ¨ç½²å’Œæ›´æ–°
- æ”¯æŒæ»šåŠ¨æ›´æ–°
- æ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹

**3. Service**ï¼š
- æä¾›ç¨³å®šçš„ç½‘ç»œè®¿é—®
- è´Ÿè½½å‡è¡¡
- æœåŠ¡å‘ç°

**4. ConfigMap/Secret**ï¼š
- ç®¡ç†é…ç½®ä¿¡æ¯
- Secretç”¨äºæ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€å¯†é’¥ï¼‰

**5. Ingress**ï¼š
- å¤–éƒ¨è®¿é—®å…¥å£
- è·¯ç”±è§„åˆ™é…ç½®
- SSLè¯ä¹¦ç®¡ç†

**Kubernetesæ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å·¥ä½œèŠ‚ç‚¹ï¼ˆWorkerï¼‰          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Pod                              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚Container1â”‚  â”‚Container2â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ§åˆ¶å¹³é¢ï¼ˆMasterï¼‰          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ API      â”‚ â”‚ Schedulerâ”‚ â”‚ etcd     â”‚ â”‚
â”‚  â”‚ Server   â”‚ â”‚ (è°ƒåº¦å™¨) â”‚ â”‚ (å­˜å‚¨)   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. é™æµç†”æ–­ï¼ˆSentinelï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦é™æµç†”æ–­ï¼Ÿ**
- **é™æµ**ï¼šä¿æŠ¤ç³»ç»Ÿä¸è¢«çªå‘æµé‡æ‰“å®
- **ç†”æ–­**ï¼šé˜²æ­¢æ•…éšœæ‰©æ•£ï¼Œå¿«é€Ÿå¤±è´¥
- **é™çº§**ï¼šä¿è¯æ ¸å¿ƒåŠŸèƒ½å¯ç”¨

**é™æµç®—æ³•**ï¼š

**1. è®¡æ•°å™¨ç®—æ³•**ï¼š
```
æ—¶é—´çª—å£å†…æœ€å¤šNä¸ªè¯·æ±‚
[00:00 - 00:59]: 100/100 requests allowed
[01:00 - 01:59]: 0/100 requests (reset)
é—®é¢˜ï¼šçª—å£è¾¹ç•Œçªå‘æµé‡
```

**2. æ»‘åŠ¨çª—å£ç®—æ³•**ï¼š
```
æ›´ç²¾ç¡®çš„é™æµï¼ŒæŒ‰å°æ—¶é—´ç‰‡æ»‘åŠ¨
æ¯åˆ†é’Ÿé™åˆ¶100ä¸ªè¯·æ±‚
```

**3. ä»¤ç‰Œæ¡¶ç®—æ³•**ï¼š
```
ä»¥å›ºå®šé€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œè¯·æ±‚æ¶ˆè€—ä»¤ç‰Œ
ä¼˜ç‚¹ï¼šå…è®¸çªå‘æµé‡ï¼Œå¹³å‡é€Ÿç‡ç¨³å®š
```

**ç†”æ–­å™¨ä¸‰ç§çŠ¶æ€**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     å¤±è´¥ç‡>é˜ˆå€¼      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å…³é—­       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚   æ‰“å¼€       â”‚
â”‚ (æ­£å¸¸é€šè¿‡)   â”‚                     â”‚ (å¿«é€Ÿå¤±è´¥)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â–²                                    â”‚
       â”‚    æˆåŠŸæˆ–è¶…æ—¶åå°è¯•åŠå¼€             â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   åŠå¼€       â”‚
                    â”‚ (å…è®¸å°‘é‡)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. åˆ†å¸ƒå¼äº‹åŠ¡

**ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ**
è·¨å¤šä¸ªæœåŠ¡æˆ–æ•°æ®åº“çš„äº‹åŠ¡ï¼Œéœ€è¦ä¿è¯ACIDç‰¹æ€§ã€‚

**CAPå®šç†**ï¼š
- **Cï¼ˆConsistencyï¼‰**ï¼šä¸€è‡´æ€§
- **Aï¼ˆAvailabilityï¼‰**ï¼šå¯ç”¨æ€§
- **Pï¼ˆPartition toleranceï¼‰**ï¼šåˆ†åŒºå®¹é”™æ€§
- **ç»“è®º**ï¼šæœ€å¤šåŒæ—¶æ»¡è¶³ä¸¤ä¸ª

**BASEç†è®º**ï¼š
- **Basically Available**ï¼šåŸºæœ¬å¯ç”¨
- **Soft state**ï¼šè½¯çŠ¶æ€
- **Eventually consistent**ï¼šæœ€ç»ˆä¸€è‡´æ€§

**åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ**ï¼š

**1. ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰**ï¼š
```
é˜¶æ®µ1ï¼šå‡†å¤‡ï¼ˆPrepareï¼‰
åè°ƒè€… â†’ è¯¢é—®æ‰€æœ‰å‚ä¸è€…æ˜¯å¦å¯ä»¥æäº¤
å‚ä¸è€… â†’ æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œé”å®šèµ„æº
       â†’ è¿”å›Yes/No

é˜¶æ®µ2ï¼šæäº¤ï¼ˆCommitï¼‰
å¦‚æœæ‰€æœ‰Yesï¼š
  åè°ƒè€… â†’ å‘é€Commitå‘½ä»¤
  å‚ä¸è€… â†’ æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œé‡Šæ”¾é”
  
å¦‚æœä»»ä¸€Noï¼š
  åè°ƒè€… â†’ å‘é€Rollbackå‘½ä»¤
  å‚ä¸è€… â†’ å›æ»šæœ¬åœ°äº‹åŠ¡ï¼Œé‡Šæ”¾é”

ç¼ºç‚¹ï¼šåŒæ­¥é˜»å¡ï¼Œå•ç‚¹æ•…éšœ
```

**2. Sagaæ¨¡å¼**ï¼š
```
å°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡
æ¯ä¸ªæœ¬åœ°äº‹åŠ¡æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œ

æ­£å‘æµç¨‹ï¼šT1 â†’ T2 â†’ T3
è¡¥å¿æµç¨‹ï¼šå¦‚æœT3å¤±è´¥ï¼Œæ‰§è¡Œ C2 â†’ C1

é€‚ç”¨ï¼šé•¿äº‹åŠ¡ä¸šåŠ¡ï¼Œå¦‚è®¢å•ã€æ”¯ä»˜ã€åº“å­˜
```

**3. TCCï¼ˆTry-Confirm-Cancelï¼‰**ï¼š
```
Tryï¼šé¢„ç•™èµ„æº
Confirmï¼šç¡®è®¤æ‰§è¡Œ
Cancelï¼šå–æ¶ˆé‡Šæ”¾

ç¤ºä¾‹ï¼ˆæ‰£å‡åº“å­˜ï¼‰ï¼š
Tryï¼šæ£€æŸ¥åº“å­˜ï¼Œå†»ç»“å¾…æ‰£å‡çš„åº“å­˜
Confirmï¼šç¡®è®¤æ‰£å‡ï¼Œå‡å°‘çœŸå®åº“å­˜
Cancelï¼šé‡Šæ”¾å†»ç»“çš„åº“å­˜
```

### 5. ç›‘æ§å‘Šè­¦ä½“ç³»

**å¯è§‚æµ‹æ€§ä¸‰æ”¯æŸ±**ï¼š
1. **Metricsï¼ˆæŒ‡æ ‡ï¼‰**ï¼šQPSã€å»¶è¿Ÿã€é”™è¯¯ç‡
2. **Loggingï¼ˆæ—¥å¿—ï¼‰**ï¼šè¯·æ±‚è¯¦æƒ…ã€é”™è¯¯å †æ ˆ
3. **Tracingï¼ˆè¿½è¸ªï¼‰**ï¼šè¯·æ±‚é“¾è·¯

**Prometheus**ï¼š
- æ—¶åºæ•°æ®åº“
- Pullæ¨¡å¼é‡‡é›†æ•°æ®
- PromQLæŸ¥è¯¢è¯­è¨€
- æ”¯æŒå‘Šè­¦è§„åˆ™

**Grafana**ï¼š
- å¯è§†åŒ–ä»ªè¡¨ç›˜
- æ”¯æŒå¤šç§æ•°æ®æº
- å‘Šè­¦é€šçŸ¥

**Jaeger**ï¼š
- åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿ
- åŸºäºOpenTelemetryæ ‡å‡†
- å±•ç¤ºè¯·æ±‚é“¾è·¯

---

## èŠ‚ç‚¹è¯¦è§£

### èŠ‚ç‚¹3.1ï¼šæ¶ˆæ¯é˜Ÿåˆ—é›†æˆï¼ˆ5å¤©ï¼‰

**å­¦ä¹ ç›®æ ‡**ï¼š
- éƒ¨ç½²Kafkaé›†ç¾¤
- å®ç°ç”Ÿäº§è€…å‘é€æ¶ˆæ¯
- å®ç°æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯
- å¤„ç†æ¶ˆæ¯å¯é æ€§

**å®æ“ä»»åŠ¡**ï¼š
1. ä½¿ç”¨Docker Composeéƒ¨ç½²Kafka
2. åˆ›å»ºTopicï¼ˆæ¨¡å‹æ„å»ºä»»åŠ¡ï¼‰
3. å®ç°ç”Ÿäº§è€…å‘é€æ¨¡å‹æ„å»ºæ¶ˆæ¯
4. å®ç°æ¶ˆè´¹è€…å¤„ç†æ„å»ºä»»åŠ¡
5. å®ç°æ­»ä¿¡é˜Ÿåˆ—ï¼ˆå¤„ç†å¤±è´¥æ¶ˆæ¯ï¼‰
6. ç›‘æ§æ¶ˆè´¹å»¶è¿Ÿ

**ä»£ç ç¤ºä¾‹**ï¼š
```go
// ç”Ÿäº§è€…
producer := kafka.NewWriter(kafka.WriterConfig{
    Brokers: []string{"localhost:9092"},
    Topic:   "model-build-tasks",
})

err := producer.WriteMessages(ctx, kafka.Message{
    Key:   []byte(modelID),
    Value: jsonData,
})

// æ¶ˆè´¹è€…
reader := kafka.NewReader(kafka.ReaderConfig{
    Brokers: []string{"localhost:9092"},
    Topic:   "model-build-tasks",
    GroupID: "model-builders",
})

for {
    msg, err := reader.ReadMessage(ctx)
    if err != nil {
        log.Error("read message failed", err)
        continue
    }
    
    // å¤„ç†æ¶ˆæ¯
    if err := processMessage(msg); err != nil {
        // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
        sendToDLQ(msg)
    }
}
```

**æ£€æŸ¥ç‚¹**ï¼š
- [ ] Kafkaæ­£å¸¸è¿è¡Œ
- [ ] Topicåˆ›å»ºæˆåŠŸ
- [ ] ç”Ÿäº§è€…èƒ½å‘é€æ¶ˆæ¯
- [ ] æ¶ˆè´¹è€…èƒ½æ¶ˆè´¹æ¶ˆæ¯
- [ ] æ¶ˆæ¯ä¸ä¸¢å¤±

---

### èŠ‚ç‚¹3.2ï¼šå®¹å™¨åŒ–ä¸ç¼–æ’ï¼ˆ5å¤©ï¼‰

**å­¦ä¹ ç›®æ ‡**ï¼š
- ç¼–å†™Dockerfileä¼˜åŒ–é•œåƒ
- ç¼–å†™Kuberneteséƒ¨ç½²é…ç½®
- å®ç°æ»šåŠ¨æ›´æ–°
- é…ç½®ConfigMapå’ŒSecret

**å®æ“ä»»åŠ¡**ï¼š
1. ä¼˜åŒ–Dockerfileï¼ˆå¤šé˜¶æ®µæ„å»ºã€érootç”¨æˆ·ï¼‰
2. åˆ›å»ºKubernetes Deployment
3. åˆ›å»ºServiceå’ŒIngress
4. ç¼–å†™ConfigMapç®¡ç†é…ç½®
5. åˆ›å»ºSecretå­˜å‚¨æ•æ„Ÿä¿¡æ¯
6. ç¼–å†™Helm Chart

**Deploymentç¤ºä¾‹**ï¼š
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
      - name: api-gateway
        image: maas/api-gateway:v1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: maas-config
              key: log-level
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
```

**æ£€æŸ¥ç‚¹**ï¼š
- [ ] é•œåƒæ„å»ºæˆåŠŸä¸”ä½“ç§¯å°
- [ ] Podæ­£å¸¸å¯åŠ¨
- [ ] æœåŠ¡å¯è¢«è®¿é—®
- [ ] æ»šåŠ¨æ›´æ–°ä¸ä¸­æ–­æœåŠ¡
- [ ] ConfigMap/Secretç”Ÿæ•ˆ

---

### èŠ‚ç‚¹3.3ï¼šé™æµä¸ç†”æ–­ï¼ˆ4å¤©ï¼‰

**å­¦ä¹ ç›®æ ‡**ï¼š
- å®ç°æ¥å£é™æµ
- é…ç½®ç†”æ–­å™¨
- å®ç°é™çº§ç­–ç•¥
- ç›‘æ§é™æµç†”æ–­æŒ‡æ ‡

**å®æ“ä»»åŠ¡**ï¼š
1. é›†æˆSentinelæˆ–è‡ªç ”é™æµ
2. å®ç°ä»¤ç‰Œæ¡¶é™æµ
3. é…ç½®ç†”æ–­è§„åˆ™
4. å®ç°é™çº§é€»è¾‘
5. æš´éœ²é™æµç†”æ–­æŒ‡æ ‡

**é™æµä»£ç ç¤ºä¾‹**ï¼š
```go
// ä»¤ç‰Œæ¡¶é™æµå™¨
type TokenBucket struct {
    rate       float64   // æ¯ç§’ç”Ÿæˆä»¤ç‰Œæ•°
    capacity   int       // æ¡¶å®¹é‡
    tokens     float64   // å½“å‰ä»¤ç‰Œæ•°
    lastUpdate time.Time // ä¸Šæ¬¡æ›´æ–°æ—¶é—´
    mu         sync.Mutex
}

func (tb *TokenBucket) Allow() bool {
    tb.mu.Lock()
    defer tb.mu.Unlock()
    
    now := time.Now()
    elapsed := now.Sub(tb.lastUpdate).Seconds()
    tb.tokens = math.Min(tb.capacity, tb.tokens+elapsed*tb.rate)
    tb.lastUpdate = now
    
    if tb.tokens >= 1 {
        tb.tokens--
        return true
    }
    return false
}

// ä½¿ç”¨
limiter := NewTokenBucket(100, 200)  // æ¯ç§’100ä¸ªï¼Œæœ€å¤š200ä¸ªçªå‘

func Handler(w http.ResponseWriter, r *http.Request) {
    if !limiter.Allow() {
        http.Error(w, "rate limit exceeded", 429)
        return
    }
    // å¤„ç†è¯·æ±‚
}
```

**æ£€æŸ¥ç‚¹**ï¼š
- [ ] é™æµç”Ÿæ•ˆï¼ˆè¶…å‡ºé™åˆ¶è¿”å›429ï¼‰
- [ ] ç†”æ–­å™¨çŠ¶æ€åˆ‡æ¢æ­£ç¡®
- [ ] é™çº§é€»è¾‘å·¥ä½œæ­£å¸¸
- [ ] æŒ‡æ ‡å¯æŸ¥çœ‹

---

### èŠ‚ç‚¹3.4ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆ4å¤©ï¼‰

**å­¦ä¹ ç›®æ ‡**ï¼š
- ç†è§£åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯
- å®ç°Sagaæ¨¡å¼
- ä½¿ç”¨DTMæ¡†æ¶
- å¤„ç†äº‹åŠ¡è¡¥å¿

**å®æ“ä»»åŠ¡**ï¼š
1. åˆ†æåˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯ï¼ˆæ¨¡å‹åˆ›å»º+è®¡è´¹æ‰£å‡ï¼‰
2. è®¾è®¡Sagaäº‹åŠ¡æµç¨‹
3. é›†æˆDTMåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶
4. å®ç°äº‹åŠ¡å‚ä¸è€…
5. å®ç°è¡¥å¿é€»è¾‘
6. æµ‹è¯•äº‹åŠ¡ä¸€è‡´æ€§

**Sagaç¤ºä¾‹**ï¼š
```go
// åˆ›å»ºæ¨¡å‹ + æ‰£å‡é…é¢ çš„Sagaäº‹åŠ¡
saga := dtmcli.NewSaga(dtmServer, gid).
    Add(modelService+"/create", modelService+"/createRevert", modelData).
    Add(billingService+"/deduct", billingService+"/deductRevert", billingData)
    
err := saga.Submit()
```

**æ£€æŸ¥ç‚¹**ï¼š
- [ ] äº‹åŠ¡æ­£å¸¸æäº¤
- [ ] äº‹åŠ¡å¤±è´¥èƒ½å›æ»š
- [ ] è¡¥å¿é€»è¾‘æ­£ç¡®æ‰§è¡Œ
- [ ] æ•°æ®ä¸€è‡´æ€§ä¿è¯

---

### èŠ‚ç‚¹3.5ï¼šç›‘æ§å‘Šè­¦ä½“ç³»ï¼ˆ4å¤©ï¼‰

**å­¦ä¹ ç›®æ ‡**ï¼š
- é›†æˆPrometheusæŒ‡æ ‡
- åˆ›å»ºGrafanaä»ªè¡¨ç›˜
- é…ç½®å‘Šè­¦è§„åˆ™
- å®ç°åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

**å®æ“ä»»åŠ¡**ï¼š
1. éƒ¨ç½²Prometheus + Grafana
2. æ·»åŠ åº”ç”¨MetricsåŸ‹ç‚¹
3. åˆ›å»ºä¸šåŠ¡ä»ªè¡¨ç›˜ï¼ˆQPS/å»¶è¿Ÿ/é”™è¯¯ç‡ï¼‰
4. é…ç½®å‘Šè­¦è§„åˆ™ï¼ˆé’‰é’‰/ä¼ä¸šå¾®ä¿¡é€šçŸ¥ï¼‰
5. é›†æˆJaegeré“¾è·¯è¿½è¸ª
6. å…³è”æ—¥å¿—å’Œè¿½è¸ªID

**PrometheusæŒ‡æ ‡ç¤ºä¾‹**ï¼š
```go
// å®šä¹‰æŒ‡æ ‡
var (
    requestDuration = prometheus.NewHistogramVec(
        prometheus.HistogramOpts{
            Name: "http_request_duration_seconds",
            Help: "HTTP request duration",
        },
        []string{"method", "path"},
    )
    
    requestTotal = prometheus.NewCounterVec(
        prometheus.CounterOpts{
            Name: "http_requests_total",
            Help: "Total HTTP requests",
        },
        []string{"method", "path", "status"},
    )
)

// ä½¿ç”¨
start := time.Now()
// å¤„ç†è¯·æ±‚
duration := time.Since(start).Seconds()

requestDuration.WithLabelValues(method, path).Observe(duration)
requestTotal.WithLabelValues(method, path, status).Inc()
```

**æ£€æŸ¥ç‚¹**ï¼š
- [ ] Prometheusèƒ½æŠ“å–æŒ‡æ ‡
- [ ] Grafanaä»ªè¡¨ç›˜å¯æŸ¥çœ‹
- [ ] å‘Šè­¦é€šçŸ¥èƒ½æ”¶åˆ°
- [ ] é“¾è·¯è¿½è¸ªå±•ç¤ºå®Œæ•´
- [ ] æ—¥å¿—å’Œè¿½è¸ªå…³è”

---

## é˜¶æ®µ3é‡Œç¨‹ç¢‘

### å®Œæˆæ£€æŸ¥æ¸…å•

**æ¶ˆæ¯é˜Ÿåˆ—**ï¼š
- [ ] Kafkaæ­£å¸¸è¿è¡Œ
- [ ] å¼‚æ­¥ä»»åŠ¡å¤„ç†æ­£å¸¸
- [ ] æ¶ˆæ¯ä¸ä¸¢å¤±

**Kubernetes**ï¼š
- [ ] æœåŠ¡éƒ¨ç½²åˆ°K8s
- [ ] æ»šåŠ¨æ›´æ–°æˆåŠŸ
- [ ] è‡ªåŠ¨æ‰©ç¼©å®¹é…ç½®

**é™æµç†”æ–­**ï¼š
- [ ] é™æµè§„åˆ™ç”Ÿæ•ˆ
- [ ] ç†”æ–­å™¨å·¥ä½œæ­£å¸¸
- [ ] é™çº§é€»è¾‘å¯ç”¨

**åˆ†å¸ƒå¼äº‹åŠ¡**ï¼š
- [ ] Sagaäº‹åŠ¡æ­£å¸¸
- [ ] è¡¥å¿é€»è¾‘æ­£ç¡®
- [ ] æ•°æ®ä¸€è‡´

**ç›‘æ§å‘Šè­¦**ï¼š
- [ ] æŒ‡æ ‡é‡‡é›†æ­£å¸¸
- [ ] ä»ªè¡¨ç›˜å¯æŸ¥çœ‹
- [ ] å‘Šè­¦èƒ½æ”¶åˆ°

### å¯æ¼”ç¤ºåŠŸèƒ½
1. æ¨¡å‹ä¸Šä¼ åå¼‚æ­¥æ„å»º
2. K8séƒ¨ç½²å’Œæ‰©ç¼©å®¹
3. é™æµç†”æ–­æ¼”ç¤º
4. åˆ†å¸ƒå¼äº‹åŠ¡æ¼”ç¤º
5. ç›‘æ§ä»ªè¡¨ç›˜å±•ç¤º

### ä¸‹ä¸€æ­¥
è¿›å…¥**é˜¶æ®µ4ï¼šé«˜çº§ç‰¹æ€§ä¸ä¼˜åŒ–**

---

**ç»§ç»­å­¦ä¹ **ï¼š[é˜¶æ®µ4æ–‡æ¡£](../05-phase4/README.md)